<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Meeq - Connetti. Scopri. Gioca.</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --meeq-pink:#E91E8C;
      --meeq-purple:#8B5CF6;
      --meeq-dark:#1a1625;
      --meeq-darker:#0f0b14;
    }
    body{
      margin:0;
      font-family:'Inter',sans-serif;
      background:var(--meeq-dark);
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
    }
    h1,h2,h3,.font-display{
      font-family:'Montserrat',sans-serif;
      font-weight:900;
    }
    .bg-meeq-gradient{
      background:linear-gradient(135deg,var(--meeq-dark) 0%,var(--meeq-darker) 100%);
    }
    .text-meeq-pink{color:var(--meeq-pink);}
    .bg-meeq-pink{background-color:var(--meeq-pink);}
    .hover\:bg-meeq-pink-dark:hover{background-color:#c71875;}
    
    /* üî• MOD 3: MOBILE KEYBOARD RESPONSIVE - CRITICAL */
    .chat-container{
      display:flex;
      flex-direction:column;
      height:100vh;
      height:100dvh; /* Dynamic viewport height - si adatta alla tastiera */
      min-height:-webkit-fill-available; /* Fallback iOS */
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      overflow:hidden;
      width:100%;
    }
    
    /* Header sempre visibile */
    .chat-header{
      position:sticky;
      top:0;
      z-index:50;
      flex-shrink:0;
      background:white;
      width:100%;
    }
    
    /* Area messaggi scrollabile */
    .chat-messages{
      flex:1 1 auto;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      min-height:0; /* Critical per flexbox */
    }
    
    /* Input sempre visibile in basso */
    .chat-input-container{
      position:sticky;
      bottom:0;
      z-index:50;
      flex-shrink:0;
      background:white;
      width:100%;
    }
    
    /* üî• MOD 3: Previene zoom su input focus (iOS) */
    input,textarea,select{
      font-size:16px !important;
      -webkit-appearance:none;
      border-radius:0;
    }
    
    /* üî• MOD 3: Fix per iPhone notch e safe area */
    @supports (padding:max(0px)){
      .chat-input-container{
        padding-bottom:max(1rem,env(safe-area-inset-bottom));
      }
      .chat-header{
        padding-top:max(1rem,env(safe-area-inset-top));
      }
    }
    
    /* üî• MOD 3: Previene bounce scroll su iOS */
    html,body{
      overscroll-behavior-y:none;
      position:fixed;
      overflow:hidden;
      width:100%;
      height:100%;
    }
    #root{
      width:100%;
      height:100%;
      overflow:auto;
    }
    
    /* üî• MOD 3: Fix viewport per browser che supportano dvh */
    @supports (height:100dvh){
      .chat-container{
        height:100dvh !important;
      }
    }
    
    /* üî• MOD 3: Android keyboard fix */
    @media (max-height:500px){
      .chat-header{
        padding:0.5rem 1rem;
      }
      .chat-input-container{
        padding:0.5rem 1rem;
      }
    }
    
    /* Animazioni */
    .message-bubble{animation:slideIn 0.3s ease-out;}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    
    .chat-bubble-sent{
      background:#E91E8C;
      color:white;
      border-radius:18px 18px 4px 18px;
      padding:12px 16px;
      margin-left:auto;
      max-width:70%;
    }
    .chat-bubble-received{
      background:#f3f4f6;
      color:#1f2937;
      border-radius:18px 18px 18px 4px;
      padding:12px 16px;
      max-width:70%;
    }
    .chat-bubble-hidden{
      background:#fee;
      color:#999;
      border-radius:18px;
      padding:12px 16px;
      max-width:70%;
      font-style:italic;
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef}=React;

// Icone SVG
const Send=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>;
const Users=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>;
const LogOut=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>;
const MessageCircle=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>;
const ArrowLeft=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>;
const Mail=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>;
const Check=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>;
const XIcon=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>;
const UserPlus=({className})=><svg className={className||''} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>;

function MeeqApp(){
const [screen,setScreen]=useState('loading');
const [user,setUser]=useState(null);
const [token,setToken]=useState(null);
const [assignedTable,setAssignedTable]=useState(null);
const [formData,setFormData]=useState({nome:'',cognome:'',email:'',telefono:'',pin:'',privacyAccepted:false,newsletterAccepted:false});
const [activeTables,setActiveTables]=useState([]);
const [selectedTable,setSelectedTable]=useState(null);
const [tableUsers,setTableUsers]=useState([]);
const [conversations,setConversations]=useState([]);
const [currentConversation,setCurrentConversation]=useState(null);
const [messages,setMessages]=useState([]);
const [newMessage,setNewMessage]=useState('');
const [unreadCount,setUnreadCount]=useState(0);
const [error,setError]=useState('');
const [loading,setLoading]=useState(false);
const [success,setSuccess]=useState('');
const API_URL=window.location.origin+'/api';
const messagesEndRef=useRef(null);

// SESSION RESTORE
useEffect(()=>{
  const restoreSession=async()=>{
    try{
      const savedToken=localStorage.getItem('meeq_token');
      const savedUser=localStorage.getItem('meeq_user');
      
      if(savedToken && savedUser){
        const userData=JSON.parse(savedUser);
        const tokenAge=Date.now()-userData.timestamp;
        
        if(tokenAge < 24*60*60*1000){
          const res=await fetch(`${API_URL}/verify-session`,{
            headers:{'Authorization':`Bearer ${savedToken}`}
          });
          
          if(res.ok){
            const data=await res.json();
            setToken(savedToken);
            setUser(data.user);
            setScreen('tables');
            console.log('‚úÖ Sessione ripristinata:',data.user.email);
            return;
          }
        }
        
        localStorage.removeItem('meeq_token');
        localStorage.removeItem('meeq_user');
      }
    }catch(err){
      console.error('‚ùå Errore ripristino sessione:',err);
      localStorage.removeItem('meeq_token');
      localStorage.removeItem('meeq_user');
    }
    
    const savedEmail=localStorage.getItem('meeq_email');
    if(savedEmail){
      setFormData(prev=>({...prev,email:savedEmail}));
    }
    
    const params=new URLSearchParams(window.location.search);
    const tableParam=params.get('tavolo');
    if(tableParam){
      const tableNumber=tableParam.replace('tavolo-','');
      setAssignedTable(tableNumber);
      console.log('ü™ë Tavolo da QR:',tableNumber);
    }
    
    setScreen('email');
  };
  
  restoreSession();
},[]);

useEffect(()=>{
  if(token && user){
    localStorage.setItem('meeq_token',token);
    localStorage.setItem('meeq_user',JSON.stringify({
      ...user,
      timestamp:Date.now()
    }));
  }
},[token,user]);

useEffect(()=>{
  if(formData.email){
    localStorage.setItem('meeq_email',formData.email);
  }
},[formData.email]);

useEffect(()=>{
  if(screen==='tables' && token){
    loadActiveTables();
    const interval=setInterval(loadActiveTables,5000);
    return ()=>clearInterval(interval);
  }
},[screen,token]);

useEffect(()=>{
  if(token && user){
    loadUnreadCount();
    const interval=setInterval(loadUnreadCount,2000);
    return ()=>clearInterval(interval);
  }
},[token,user]);

useEffect(()=>{
  if(screen==='conversations' && token){
    loadConversations();
    const interval=setInterval(loadConversations,3000);
    return ()=>clearInterval(interval);
  }
},[screen,token]);

useEffect(()=>{
  if(screen==='chat' && currentConversation && token){
    loadMessages();
    const interval=setInterval(loadMessages,2000);
    return ()=>clearInterval(interval);
  }
},[screen,currentConversation,token]);

// üî• FIX v7: Polling stato conversazione per aggiornare "In attesa" ‚Üí "Accettata"
useEffect(()=>{
  if(screen==='chat' && currentConversation && currentConversation.id && token){
    const checkConversationStatus=async()=>{
      try{
        const res=await fetch(`${API_URL}/conversations`,{
          headers:{'Authorization':`Bearer ${token}`}
        });
        if(res.ok){
          const convs=await res.json();
          const updated=convs.find(c=>c.id===currentConversation.id);
          if(updated && updated.status!==currentConversation.status){
            console.log('üîÑ Stato conversazione aggiornato:', currentConversation.status, '‚Üí', updated.status);
            setCurrentConversation(prev=>({...prev, ...updated}));
          }
        }
      }catch(err){console.error('Errore check status:',err);}
    };
    
    const interval=setInterval(checkConversationStatus,2000);
    return ()=>clearInterval(interval);
  }
},[screen,currentConversation?.id,token]);

useEffect(()=>{
  messagesEndRef.current?.scrollIntoView({behavior:'smooth'});
},[messages]);

useEffect(()=>{
  if(error || success){
    const timer=setTimeout(()=>{
      setError('');
      setSuccess('');
    },5000);
    return ()=>clearTimeout(timer);
  }
},[error,success]);

// üî• MOD 3: Gestione dinamica viewport per keyboard mobile
useEffect(()=>{
  const handleResize=()=>{
    // Aggiorna CSS variable con l'altezza corrente del viewport
    const vh=window.innerHeight*0.01;
    document.documentElement.style.setProperty('--vh',`${vh}px`);
    
    // iOS visualViewport API per gestione avanzata keyboard
    if(window.visualViewport){
      const vvh=window.visualViewport.height*0.01;
      document.documentElement.style.setProperty('--vvh',`${vvh}px`);
    }
  };
  
  handleResize();
  window.addEventListener('resize',handleResize);
  window.addEventListener('orientationchange',handleResize);
  
  // iOS visualViewport specifico
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize',handleResize);
    window.visualViewport.addEventListener('scroll',handleResize);
  }
  
  return ()=>{
    window.removeEventListener('resize',handleResize);
    window.removeEventListener('orientationchange',handleResize);
    if(window.visualViewport){
      window.visualViewport.removeEventListener('resize',handleResize);
      window.visualViewport.removeEventListener('scroll',handleResize);
    }
  };
},[]);

const loadUnreadCount=async()=>{
  try{
    // üî• MOD 2: Usa nuovo endpoint che conta TUTTI i messaggi non letti
    const res=await fetch(`${API_URL}/messages/unread-count`,{
      headers:{'Authorization':`Bearer ${token}`}
    });
    if(res.ok){
      const data=await res.json();
      setUnreadCount(data.unreadCount);
    }
  }catch(err){console.error('Errore:',err);}
};

const loadActiveTables=async()=>{
  try{
    const res=await fetch(`${API_URL}/tables/active`,{
      headers:{'Authorization':`Bearer ${token}`}
    });
    if(res.ok){
      const data=await res.json();
      const filtered=data.filter(t=>{
        const tNum=t.room_id.replace('tavolo-','');
        return tNum!==user.tavolo;
      });
      setActiveTables(filtered||[]);
    }
  }catch(err){console.error('Errore:',err);}
};

const loadTableUsers=async(tableId)=>{
  try{
    const res=await fetch(`${API_URL}/tables/${tableId}/users`,{
      headers:{'Authorization':`Bearer ${token}`}
    });
    if(res.ok){
      const data=await res.json();
      return data||[];
    }
  }catch(err){console.error('Errore:',err);}
  return [];
};

const loadConversations=async()=>{
  try{
    const res=await fetch(`${API_URL}/conversations`,{
      headers:{'Authorization':`Bearer ${token}`}
    });
    if(res.ok){
      const data=await res.json();
      // üî• ORDINA: pending in alto
      const sorted=data.sort((a,b)=>{
        if(a.status==='pending' && b.status!=='pending')return -1;
        if(a.status!=='pending' && b.status==='pending')return 1;
        return new Date(b.updated_at)-new Date(a.updated_at);
      });
      setConversations(sorted||[]);
    }
  }catch(err){console.error('Errore:',err);}
};

const loadMessages=async()=>{
  try{
    const res=await fetch(`${API_URL}/conversations/${currentConversation.id}/messages`,{
      headers:{'Authorization':`Bearer ${token}`}
    });
    if(res.ok){
      const data=await res.json();
      const messagesWithFlag=data.messages.map(msg=>({
        ...msg,
        isMine:msg.sender_id===user.id
      }));
      setMessages(messagesWithFlag);
      
      // üî• MOD 1: Aggiorna anche status e initiator_id
      setCurrentConversation(prev=>({
        ...prev,
        user1_revealed:data.user1_revealed,
        user2_revealed:data.user2_revealed,
        status:data.status,
        initiator_id:data.initiator_id
      }));
    }
  }catch(err){console.error('Errore:',err);}
};

const checkEmail=async(e)=>{
  e.preventDefault();
  setError('');
  setLoading(true);
  
  try{
    const res=await fetch(`${API_URL}/check-email`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email:formData.email})
    });
    const data=await res.json();
    
    if(res.ok){
      if(data.exists){
        setScreen('pin');
        setSuccess('Ti abbiamo inviato un nuovo PIN via email!');
      }else{
        setScreen('register');
      }
    }else{
      setError(data.error||'Errore verifica email');
    }
  }catch(err){
    setError('Errore di connessione');
  }finally{
    setLoading(false);
  }
};

const register=async(e)=>{
  e.preventDefault();
  setError('');
  setLoading(true);
  
  try{
    const res=await fetch(`${API_URL}/register`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        nome:formData.nome,
        cognome:formData.cognome,
        email:formData.email,
        telefono:formData.telefono,
        privacyAccepted:formData.privacyAccepted,
        newsletterAccepted:formData.newsletterAccepted
      })
    });
    const data=await res.json();
    
    if(res.ok){
      setScreen('pin');
      setSuccess('PIN inviato via email! Controlla la tua casella.');
    }else{
      setError(data.error||'Errore registrazione');
    }
  }catch(err){
    setError('Errore di connessione');
  }finally{
    setLoading(false);
  }
};

const verifyPin=async(e)=>{
  e.preventDefault();
  setError('');
  setLoading(true);
  
  try{
    const res=await fetch(`${API_URL}/verify-pin`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        email:formData.email,
        pin:formData.pin,
        tavolo:assignedTable
      })
    });
    const data=await res.json();
    
    if(res.ok){
      setToken(data.token);
      setUser({
        id:data.userId,
        email:formData.email,
        tavolo:data.tavolo
      });
      setScreen('tables');
      setSuccess('Login effettuato!');
    }else{
      setError(data.error||'PIN non valido');
    }
  }catch(err){
    setError('Errore di connessione');
  }finally{
    setLoading(false);
  }
};

const logout=async()=>{
  try{
    await fetch(`${API_URL}/logout`,{
      method:'POST',
      headers:{'Authorization':`Bearer ${token}`}
    });
  }catch(err){console.error('Errore logout:',err);}
  
  setToken(null);
  setUser(null);
  setConversations([]);
  setMessages([]);
  setCurrentConversation(null);
  localStorage.removeItem('meeq_token');
  localStorage.removeItem('meeq_user');
  setScreen('email');
};

// üî• FIX v4: APRI CHAT DIRETTAMENTE + DEBUG
const startConversation=async(recipientId)=>{
  console.log('üöÄ startConversation chiamata con recipientId:', recipientId);
  console.log('üîë Token:', token);
  console.log('üåê API_URL:', API_URL);
  
  try{
    console.log('üì° Invio richiesta POST /conversations...');
    const res=await fetch(`${API_URL}/conversations`,{
      method:'POST',
      headers:{
        'Authorization':`Bearer ${token}`,
        'Content-Type':'application/json'
      },
      body:JSON.stringify({recipientId})
    });
    
    console.log('üì• Risposta ricevuta, status:', res.status);
    
    if(res.ok){
      const data=await res.json();
      console.log('‚úÖ Conversazione creata:', data);
      
      // üî• FIX v7: Gestisce sia data.conversation che data direttamente
      const newConv = data.conversation || data;
      if(!newConv || !newConv.id){
        console.error('‚ùå ERRORE: conversazione non creata!', data);
        setError('Errore: conversazione non creata correttamente');
        return;
      }
      
      // APRI la chat direttamente
      setCurrentConversation(newConv);
      setScreen('chat');
      console.log('‚úÖ Chat aperta con conversazione:', newConv);
    }else{
      const data=await res.json();
      console.error('‚ùå Errore API:', data);
      setError(data.error||'Errore avvio conversazione');
    }
  }catch(err){
    console.error('‚ùå CATCH ERROR:', err);
    setError('Errore di connessione: ' + err.message);
  }
};

// üî• FIX v4: Dopo accettazione, ricarica conversazione
const acceptConversation=async(conversationId)=>{
  try{
    const res=await fetch(`${API_URL}/conversations/${conversationId}`,{
      method:'PATCH',
      headers:{
        'Authorization':`Bearer ${token}`,
        'Content-Type':'application/json'
      },
      body:JSON.stringify({status:'accepted'})
    });
    
    if(res.ok){
      // Ricarica conversazione corrente se siamo in chat
      if(currentConversation && currentConversation.id===conversationId){
        setCurrentConversation(prev=>({...prev,status:'accepted'}));
        loadMessages();
      }
      loadConversations();
      loadUnreadCount();
      setSuccess('Conversazione accettata!');
    }
  }catch(err){
    setError('Errore');
  }
};

const blockConversation=async(conversationId)=>{
  try{
    const res=await fetch(`${API_URL}/conversations/${conversationId}`,{
      method:'PATCH',
      headers:{
        'Authorization':`Bearer ${token}`,
        'Content-Type':'application/json'
      },
      body:JSON.stringify({status:'blocked'})
    });
    
    if(res.ok){
      loadConversations();
      loadUnreadCount();
      setSuccess('Conversazione bloccata');
      // Torna alla lista conversazioni se eri in quella chat
      if(currentConversation && currentConversation.id===conversationId){
        setScreen('conversations');
      }
    }
  }catch(err){
    setError('Errore');
  }
};

const revealName=async()=>{
  try{
    const res=await fetch(`${API_URL}/conversations/${currentConversation.id}/reveal`,{
      method:'POST',
      headers:{'Authorization':`Bearer ${token}`}
    });
    
    if(res.ok){
      setSuccess('Nome condiviso!');
      loadMessages();
    }
  }catch(err){
    setError('Errore');
  }
};

const sendMessage=async(e)=>{
  e.preventDefault();
  if(!newMessage.trim())return;
  
  try{
    const res=await fetch(`${API_URL}/messages`,{
      method:'POST',
      headers:{
        'Authorization':`Bearer ${token}`,
        'Content-Type':'application/json'
      },
      body:JSON.stringify({
        recipientId:currentConversation.other_user_id,
        message:newMessage,
        conversationId:currentConversation.id
      })
    });
    
    if(res.ok){
      setNewMessage('');
      loadMessages();
    }
  }catch(err){
    setError('Errore invio messaggio');
  }
};

// SCREEN: LOADING
if(screen==='loading'){
  return(
    <div className="min-h-screen bg-meeq-gradient flex items-center justify-center">
      <div className="text-center">
        <h1 className="text-6xl font-display text-white mb-4">meeq</h1>
        <p className="text-white/60 font-semibold">Caricamento...</p>
      </div>
    </div>
  );
}

// SCREEN: EMAIL
if(screen==='email'){
  return(
    <div className="min-h-screen bg-meeq-gradient flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <h1 className="text-5xl font-display text-center mb-2 text-meeq-pink">meeq</h1>
        <p className="text-gray-600 text-center mb-8 font-semibold">Connetti. Scopri. Gioca.</p>
        
        <form onSubmit={checkEmail} className="space-y-4">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2">Email</label>
            <input
              type="email"
              value={formData.email}
              onChange={(e)=>setFormData({...formData,email:e.target.value})}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-meeq-pink focus:outline-none"
              placeholder="tua@email.com"
              required
            />
          </div>
          
          {error&&<div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm font-semibold">{error}</div>}
          
          <button
            type="submit"
            disabled={loading}
            className="w-full bg-meeq-pink hover:bg-meeq-pink-dark text-white font-bold py-3 rounded-lg shadow-lg transition-all"
          >
            {loading?'Verifica...':'Continua'}
          </button>
        </form>
      </div>
    </div>
  );
}

// SCREEN: REGISTER
if(screen==='register'){
  return(
    <div className="min-h-screen bg-meeq-gradient flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <button onClick={()=>setScreen('email')} className="text-gray-600 hover:text-meeq-pink mb-4">
          <ArrowLeft className="w-6 h-6"/>
        </button>
        
        <h2 className="text-3xl font-display text-center mb-6 text-gray-900">Registrati</h2>
        
        <form onSubmit={register} className="space-y-4">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2">Nome</label>
            <input
              type="text"
              value={formData.nome}
              onChange={(e)=>setFormData({...formData,nome:e.target.value})}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-meeq-pink focus:outline-none"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2">Cognome</label>
            <input
              type="text"
              value={formData.cognome}
              onChange={(e)=>setFormData({...formData,cognome:e.target.value})}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-meeq-pink focus:outline-none"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2">Telefono (opzionale)</label>
            <input
              type="tel"
              value={formData.telefono}
              onChange={(e)=>setFormData({...formData,telefono:e.target.value})}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-meeq-pink focus:outline-none"
            />
          </div>
          
          <div className="space-y-3">
            <label className="flex items-start gap-3">
              <input
                type="checkbox"
                checked={formData.privacyAccepted}
                onChange={(e)=>setFormData({...formData,privacyAccepted:e.target.checked})}
                className="mt-1"
                required
              />
              <span className="text-sm text-gray-700">Accetto la privacy policy e i termini di servizio</span>
            </label>
            
            <label className="flex items-start gap-3">
              <input
                type="checkbox"
                checked={formData.newsletterAccepted}
                onChange={(e)=>setFormData({...formData,newsletterAccepted:e.target.checked})}
                className="mt-1"
              />
              <span className="text-sm text-gray-700">Voglio ricevere la newsletter</span>
            </label>
          </div>
          
          {error&&<div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm font-semibold">{error}</div>}
          
          <button
            type="submit"
            disabled={loading}
            className="w-full bg-meeq-pink hover:bg-meeq-pink-dark text-white font-bold py-3 rounded-lg shadow-lg transition-all"
          >
            {loading?'Registrazione...':'Registrati'}
          </button>
        </form>
      </div>
    </div>
  );
}

// SCREEN: PIN
if(screen==='pin'){
  return(
    <div className="min-h-screen bg-meeq-gradient flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <button onClick={()=>setScreen('email')} className="text-gray-600 hover:text-meeq-pink mb-4">
          <ArrowLeft className="w-6 h-6"/>
        </button>
        
        <div className="text-center mb-6">
          <Mail className="w-16 h-16 mx-auto text-meeq-pink mb-4"/>
          <h2 className="text-3xl font-display text-gray-900 mb-2">Verifica PIN</h2>
          <p className="text-gray-600">Controlla la tua email</p>
        </div>
        
        {success&&<div className="bg-green-50 text-green-600 px-4 py-3 rounded-lg text-sm font-semibold mb-4">{success}</div>}
        
        <form onSubmit={verifyPin} className="space-y-4">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2">Codice PIN</label>
            <input
              type="text"
              value={formData.pin}
              onChange={(e)=>setFormData({...formData,pin:e.target.value.replace(/\D/g,'').slice(0,6)})}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-meeq-pink focus:outline-none text-center text-2xl font-bold tracking-widest"
              placeholder="000000"
              maxLength={6}
              required
            />
          </div>
          
          {error&&<div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm font-semibold">{error}</div>}
          
          <button
            type="submit"
            disabled={loading}
            className="w-full bg-meeq-pink hover:bg-meeq-pink-dark text-white font-bold py-3 rounded-lg shadow-lg transition-all"
          >
            {loading?'Verifica...':'Accedi'}
          </button>
        </form>
      </div>
    </div>
  );
}

// SCREEN: TABLES
if(screen==='tables'){
  return(
    <div className="min-h-screen bg-meeq-gradient p-4">
      <div className="max-w-4xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-4xl font-display text-white">Tavoli Attivi</h1>
          <div className="flex gap-2">
            <button 
              onClick={()=>setScreen('conversations')} 
              className="relative text-white hover:text-meeq-pink p-2 transition-all"
            >
              <MessageCircle className="w-6 h-6"/>
              {unreadCount>0&&(
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center animate-pulse">
                  {unreadCount}
                </span>
              )}
            </button>
            <button onClick={logout} className="text-white hover:text-meeq-pink p-2 transition-all">
              <LogOut className="w-6 h-6"/>
            </button>
          </div>
        </div>
        
        {success&&<div className="bg-white text-green-600 px-4 py-3 rounded-lg font-semibold mb-4">{success}</div>}
        
        {activeTables.length===0?(
          <div className="bg-white rounded-xl p-8 text-center">
            <Users className="w-16 h-16 mx-auto text-gray-300 mb-4"/>
            <p className="text-gray-600 font-semibold">Nessun tavolo attivo al momento</p>
          </div>
        ):(
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {activeTables.map(table=>(
              <button
                key={table.room_id}
                onClick={async()=>{
                  const users=await loadTableUsers(table.room_id);
                  setSelectedTable({...table,users});
                  setScreen('table-users');
                }}
                className="bg-white rounded-xl p-6 hover:shadow-2xl transition-all"
              >
                <h3 className="text-xl font-display text-gray-900 mb-2">{table.room_name}</h3>
                <div className="flex items-center justify-center gap-2 text-meeq-pink">
                  <Users className="w-5 h-5"/>
                  <span className="font-bold">{table.user_count}</span>
                </div>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// SCREEN: TABLE USERS
if(screen==='table-users'&&selectedTable){
  return(
    <div className="min-h-screen bg-meeq-gradient p-4">
      <div className="max-w-4xl mx-auto">
        <div className="flex items-center gap-4 mb-6">
          <button onClick={()=>setScreen('tables')} className="text-white hover:text-meeq-pink">
            <ArrowLeft className="w-6 h-6"/>
          </button>
          <h1 className="text-4xl font-display text-white">{selectedTable.room_name}</h1>
        </div>
        
        {success&&<div className="bg-white text-green-600 px-4 py-3 rounded-lg font-semibold mb-4">{success}</div>}
        {error&&<div className="bg-white text-red-600 px-4 py-3 rounded-lg font-semibold mb-4">{error}</div>}
        
        <div className="space-y-3">
          {selectedTable.users.map((u,index)=>(
            <div key={u.id} className="bg-white rounded-xl p-4 flex items-center justify-between hover:shadow-2xl transition-all">
              <div>
                <h3 className="font-bold text-gray-900">Utente {index+1}</h3>
                <p className="text-sm text-gray-500">Online</p>
              </div>
              <button
                onClick={()=>startConversation(u.id)}
                className="bg-meeq-pink hover:bg-meeq-pink-dark text-white font-bold px-4 py-2 rounded-lg flex items-center gap-2 transition-all"
              >
                <MessageCircle className="w-4 h-4"/>
                Chat
              </button>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// SCREEN: CONVERSATIONS - üî• FIX v4: Mostra "Tavolo X"
if(screen==='conversations'){
  return(
    <div className="min-h-screen bg-meeq-gradient p-4">
      <div className="max-w-4xl mx-auto">
        <div className="flex items-center gap-4 mb-6">
          <button onClick={()=>setScreen('tables')} className="text-white hover:text-meeq-pink">
            <ArrowLeft className="w-6 h-6"/>
          </button>
          <h1 className="text-4xl font-display text-white">Conversazioni</h1>
        </div>
        
        {success&&<div className="bg-white text-green-600 px-4 py-3 rounded-lg font-semibold mb-4">{success}</div>}
        
        {conversations.length===0?(
          <div className="bg-white rounded-xl p-8 text-center">
            <MessageCircle className="w-16 h-16 mx-auto text-gray-300 mb-4"/>
            <p className="text-gray-600 font-semibold">Nessuna conversazione</p>
          </div>
        ):(
          <div className="space-y-3">
            {conversations.map(conv=>{
              const isUser1=conv.user1_id===user.id;
              const otherUserRevealed=isUser1?conv.user2_revealed:conv.user1_revealed;
              const showName=conv.status==='accepted'&&otherUserRevealed;
              
              // üî• FIX v4: Mostra "Tavolo X" invece di "Utente X"
              const displayName=showName
                ?conv.other_user_nome
                :`Tavolo ${conv.other_user_tavolo}`;
              
              const isPending=conv.status==='pending';
              // üî• FIX v5: Usa initiator_id per determinare chi √® il destinatario
              const isRecipient=conv.initiator_id!==user.id;
              // üî• MOD 2: Bordo rosso se pending O se ci sono messaggi non letti
              const hasUnread=conv.unread_count>0;
              const showRedBorder=(isPending&&isRecipient)||hasUnread;
              
              return(
                <div
                  key={conv.id}
                  onClick={()=>{
                    setCurrentConversation(conv);
                    setScreen('chat');
                  }}
                  className={`bg-white rounded-xl p-4 cursor-pointer hover:shadow-2xl transition-all message-bubble ${showRedBorder?'border-2 border-red-400':''}`}
                >
                  <div className="flex items-start justify-between mb-2">
                    <h3 className="font-bold text-gray-900">{displayName}</h3>
                    <span className="text-xs text-gray-400">
                      {new Date(conv.updated_at).toLocaleDateString('it-IT')}
                    </span>
                  </div>
                  
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-sm text-gray-600">
                      {conv.message_count>0?`${conv.message_count} messaggi`:'Nuova conversazione'}
                    </p>
                    {/* üî• MOD 2: Badge con numero messaggi non letti */}
                    {hasUnread&&(
                      <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                        {conv.unread_count} non {conv.unread_count===1?'letto':'letti'}
                      </span>
                    )}
                  </div>
                  
                  {isPending&&isRecipient&&(
                    <div className="text-xs text-red-600 font-bold">
                      ‚ö†Ô∏è Richiesta in attesa
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

// SCREEN: CHAT - üî• FIX v4: Bottoni Accetta/Rifiuta + Messaggi oscurati
if(screen==='chat'&&currentConversation){
  const isUser1=currentConversation.user1_id===user.id;
  const otherUserRevealed=isUser1?currentConversation.user2_revealed:currentConversation.user1_revealed;
  const myRevealed=isUser1?currentConversation.user1_revealed:currentConversation.user2_revealed;
  const showOtherName=currentConversation.status==='accepted'&&otherUserRevealed;
  const canReveal=currentConversation.status==='accepted'&&!myRevealed;
  
  // üî• FIX v4: Mostra "Tavolo X"
  const displayName=showOtherName
    ?currentConversation.other_user_nome
    :`Tavolo ${currentConversation.other_user_tavolo}`;
  
  // üî• FIX v5: Usa initiator_id per determinare chi √® il destinatario
  const isPending=currentConversation.status==='pending';
  const isRecipient=currentConversation.initiator_id!==user.id;
  const showAcceptButtons=isPending&&isRecipient;
  const hideMessages=isPending&&isRecipient; // Nasconde messaggi se pending per destinatario
  
  return(
    <div className="chat-container bg-meeq-gradient">
      <div className="chat-header shadow-lg p-4">
        <div className="max-w-2xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button onClick={()=>setScreen('conversations')} className="text-gray-600 hover:text-meeq-pink">
              <ArrowLeft className="w-6 h-6"/>
            </button>
            <div>
              <h1 className="text-xl font-display text-gray-900">{displayName}</h1>
              {/* üî• MOD 1: Mostra messaggio diverso per initiator vs recipient */}
              {isPending&&isRecipient&&<p className="text-xs text-gray-500">‚è≥ In attesa di accettazione</p>}
              {isPending&&!isRecipient&&<p className="text-xs text-green-600">‚úâÔ∏è Richiesta inviata (puoi gi√† scrivere)</p>}
            </div>
          </div>
          
          {canReveal&&(
            <button
              onClick={revealName}
              className="bg-meeq-pink hover:bg-meeq-pink-dark text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 shadow-lg transition-all"
            >
              <UserPlus className="w-4 h-4"/>
              Condividi Nome
            </button>
          )}
        </div>
        
        {/* üî• FIX v4: Bottoni Accetta/Rifiuta sotto l'header */}
        {showAcceptButtons&&(
          <div className="max-w-2xl mx-auto mt-3 flex gap-2">
            <button
              onClick={()=>acceptConversation(currentConversation.id)}
              className="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"
            >
              <Check className="w-5 h-5"/>
              Accetta Conversazione
            </button>
            <button
              onClick={()=>blockConversation(currentConversation.id)}
              className="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"
            >
              <XIcon className="w-5 h-5"/>
              Rifiuta
            </button>
          </div>
        )}
      </div>
      
      {success&&(
        <div className="max-w-2xl mx-auto px-4 py-2">
          <div className="bg-white text-green-600 px-4 py-3 rounded-lg font-semibold text-center shadow-lg">
            {success}
          </div>
        </div>
      )}
      
      <div className="chat-messages p-4">
        <div className="max-w-2xl mx-auto space-y-3">
          {messages.map(msg=>{
            // üî• FIX v4: Oscura messaggi se pending per destinatario
            const messageContent=hideMessages&&!msg.isMine?'üîí Messaggio nascosto (Accetta per leggere)':msg.message;
            const bubbleClass=hideMessages&&!msg.isMine?'chat-bubble-hidden':(msg.isMine?'chat-bubble-sent':'chat-bubble-received');
            
            return(
              <div key={msg.id} className={`flex ${msg.isMine?'justify-end':'justify-start'}`}>
                <div className={bubbleClass}>
                  <p className="whitespace-pre-wrap">{messageContent}</p>
                  <div className={`text-xs mt-1 ${msg.isMine?'text-white/70':'text-gray-500'}`}>
                    {new Date(msg.created_at).toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})}
                  </div>
                </div>
              </div>
            );
          })}
          <div ref={messagesEndRef}/>
        </div>
      </div>
      
      <div className="chat-input-container border-t border-gray-200 p-4">
        <div className="max-w-2xl mx-auto">
          {/* üî• MOD 1: Disabilita input solo se sei recipient con status pending */}
          {isPending&&isRecipient?(
            <div className="bg-gray-100 text-gray-600 text-center py-3 rounded-lg font-semibold">
              ‚è≥ Accetta la conversazione per rispondere
            </div>
          ):(
            <form onSubmit={sendMessage} className="flex gap-2">
              <input
                type="text"
                value={newMessage}
                onChange={(e)=>setNewMessage(e.target.value)}
                onFocus={(e)=>{
                  // üî• MOD 3: Scroll input in vista quando si apre keyboard
                  setTimeout(()=>{
                    e.target.scrollIntoView({behavior:'smooth',block:'center'});
                  },300);
                }}
                placeholder="Scrivi un messaggio..."
                className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-meeq-pink focus:outline-none"
              />
              <button
                type="submit"
                disabled={!newMessage.trim()}
                className="bg-meeq-pink hover:bg-meeq-pink-dark text-white font-bold px-6 py-3 rounded-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <Send className="w-5 h-5"/>
              </button>
            </form>
          )}
        </div>
      </div>
    </div>
  );
}

// üî• FIX DEBUG: Protezione screen chat senza conversazione
if(screen==='chat'&&!currentConversation){
  console.error('‚ùå ERRORE: Screen=chat ma currentConversation √® null!');
  console.log('üìç Stato attuale:', {screen, currentConversation, user, token});
  // Torna a conversazioni
  setTimeout(()=>setScreen('conversations'), 100);
  return(
    <div className="min-h-screen bg-meeq-gradient flex items-center justify-center">
      <div className="text-center text-white">
        <h1 className="text-3xl font-bold mb-4">Errore caricamento chat</h1>
        <p>Torno alla lista conversazioni...</p>
      </div>
    </div>
  );
}

return <div>Errore: schermata sconosciuta</div>;
}

ReactDOM.render(<MeeqApp/>,document.getElementById('root'));
</script>
</body>
</html>
