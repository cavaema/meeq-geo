<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meeq - Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--meeq-pink:#E91E8C;--meeq-dark:#1a1625}
body{margin:0;font-family:'Inter',sans-serif;background:var(--meeq-dark)}
h1,h2,h3{font-family:'Montserrat',sans-serif;font-weight:900}
</style>
<script src="/qrcode.min.js"></script>
</head>
<body>
<div id="root"></div>
<script>
console.log('QRCode caricato:', typeof QRCode);
if(typeof QRCode === 'undefined'){
alert('Errore: libreria QRCode non caricata.');
}
</script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect}=React;
const Printer=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>;
const Users=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>;
const Download=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>;
const Trash=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>;

function AdminApp(){
const [screen,setScreen]=useState('login');
const [token,setToken]=useState(null);
const [formData,setFormData]=useState({username:'',password:''});
const [stats,setStats]=useState({});
const [users,setUsers]=useState([]);
const [rooms,setRooms]=useState([]);
const [venues,setVenues]=useState([]);
const [venueForm,setVenueForm]=useState(null);
const [error,setError]=useState('');
const [loading,setLoading]=useState(false);
const [resetLoading,setResetLoading]=useState(false);
const [resetMessage,setResetMessage]=useState('');
const API_URL=window.location.origin+'/api';

const handleLogin=async(e)=>{
e.preventDefault();
setError('');
setLoading(true);
try{
const res=await fetch(`${API_URL}/admin/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(formData)});
const data=await res.json();
if(res.ok){
setToken(data.token);
// üÜï Salva token nel localStorage
localStorage.setItem('meeq_admin_token', data.token);
setScreen('dashboard');
loadStats(data.token);
loadUsers(data.token);
loadRooms(data.token);
loadVenues(data.token);
}else{setError(data.error||'Credenziali non valide');}
}catch(err){setError('Errore connessione');}
finally{setLoading(false);}
};

// üÜï Verifica token all'avvio
useEffect(()=>{
const savedToken=localStorage.getItem('meeq_admin_token');
if(savedToken){
// Verifica se il token √® ancora valido
fetch(`${API_URL}/admin/stats`,{headers:{'Authorization':`Bearer ${savedToken}`}})
.then(res=>{
if(res.ok){
setToken(savedToken);
setScreen('dashboard');
loadStats(savedToken);
loadUsers(savedToken);
loadRooms(savedToken);
loadVenues(savedToken);
}else{
// Token non valido, rimuovilo
localStorage.removeItem('meeq_admin_token');
}
})
.catch(()=>{
localStorage.removeItem('meeq_admin_token');
});
}
},[]);

const loadStats=async(tkn)=>{
try{
const res=await fetch(`${API_URL}/admin/stats`,{headers:{'Authorization':`Bearer ${tkn||token}`}});
const data=await res.json();
setStats(data);
}catch(err){console.error('Errore:',err);}
};

const loadUsers=async(tkn)=>{
try{
const res=await fetch(`${API_URL}/admin/users`,{headers:{'Authorization':`Bearer ${tkn||token}`}});
const data=await res.json();
setUsers(data);
}catch(err){console.error('Errore:',err);}
};

const loadVenues=async(tkn)=>{
try{
const res=await fetch(`${API_URL}/admin/venues`,{headers:{'Authorization':`Bearer ${tkn||token}`}});
const data=await res.json();
setVenues(Array.isArray(data)?data:[]);
}catch(err){console.error('Errore venues:',err);}
};

const loadRooms=async(tkn)=>{
// Genera i 30 tavoli statici
const generatedRooms=[];
for(let i=1;i<=30;i++){
generatedRooms.push({id:`tavolo-${i}`,name:`Tavolo ${i}`,user_count:0});
}
generatedRooms.push({id:'generale',name:'Chat Generale',user_count:0});
setRooms(generatedRooms);
};

const handleReset=async()=>{
if(!confirm('‚ö†Ô∏è SEI SICURO?\n\nQuesta operazione canceller√†:\n- TUTTE le conversazioni\n- TUTTI i messaggi\n- Logout di tutti gli utenti\n\nGli account utenti saranno mantenuti.\n\nConfermi?')){
return;
}
setResetLoading(true);
setResetMessage('');
try{
const res=await fetch(`${API_URL}/admin/reset`,{method:'POST',headers:{'Authorization':`Bearer ${token}`}});
const data=await res.json();
if(data.success){
setResetMessage('success');
loadStats();
loadUsers();
setTimeout(()=>setResetMessage(''),5000);
}else{
setResetMessage('error');
}
}catch(err){
console.error('Errore reset:',err);
setResetMessage('error');
}finally{
setResetLoading(false);
}
};

const saveVenue=async()=>{
if(!venueForm||!venueForm.name)return;
const tkn=token;
try{
const body={name:venueForm.name,slug:venueForm.slug||'',logo_url:venueForm.logo_url||'',menu_url:venueForm.menu_url||'',latitude:venueForm.latitude||null,longitude:venueForm.longitude||null,radius_meters:venueForm.radius_meters||80,central_api_key:venueForm.central_api_key||'',active:venueForm.active!==0?1:0,owner_username:venueForm.owner_username||'',owner_password:venueForm.owner_password||''};
if(venueForm.id){
await fetch(`${API_URL}/admin/venues/${venueForm.id}`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':`Bearer ${tkn}`},body:JSON.stringify(body)});
}else{
await fetch(`${API_URL}/admin/venues`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${tkn}`},body:JSON.stringify(body)});
}
setVenueForm(null);
loadVenues();
}catch(err){alert('Errore salvataggio locale');}
};

let currentUploadVenueId=null;
const adminMenuInput=document.createElement('input');
adminMenuInput.type='file';
adminMenuInput.accept='.pdf,application/pdf';
adminMenuInput.style.display='none';
adminMenuInput.onchange=async function(){
if(!currentUploadVenueId||!this.files||!this.files[0]){currentUploadVenueId=null;this.value='';return;}
const fd=new FormData();
fd.append('menu',this.files[0]);
try{
const res=await fetch(`${API_URL}/venue/${currentUploadVenueId}/upload-menu`,{method:'POST',headers:{'Authorization':'Bearer '+(localStorage.getItem('meeq_admin_token')||token)},body:fd});
const data=await res.json();
if(res.ok&&data.success){alert('Menu caricato con successo');loadVenues();}else{alert(data.error||'Errore upload');}
}catch(e){alert('Errore: '+e.message);}
currentUploadVenueId=null;
this.value='';
};
document.body.appendChild(adminMenuInput);

const uploadMenuAdmin=(venue)=>{
currentUploadVenueId=venue.id;
adminMenuInput.click();
};

const printVenueQR=async(venue)=>{
const baseURL=window.location.origin;
const qrURL=baseURL+'/venue/'+(venue.slug||venue.id);
const div=document.createElement('div');
div.style.display='none';
document.body.appendChild(div);
try{
new QRCode(div,{text:qrURL,width:400,height:400});
await new Promise(r=>setTimeout(r,300));
const canvas=div.querySelector('canvas');
if(!canvas){alert('Errore generazione QR');document.body.removeChild(div);return;}
const dataURL=canvas.toDataURL();
document.body.removeChild(div);
const w=window.open('','_blank');
w.document.write('<html><head><title>QR '+venue.name+'</title>');
w.document.write('<style>body{margin:0;font-family:Arial;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:40px}.qr-title{font-size:32px;font-weight:900;color:#E91E8C;margin-bottom:16px}.qr-subtitle{font-size:18px;color:#666;margin-bottom:24px}.qr-url{font-size:12px;color:#999;word-break:break-all;margin-top:16px}@media print{body{-webkit-print-color-adjust:exact}}</style>');
w.document.write('</head><body>');
w.document.write('<div class="qr-title">meeq</div>');
w.document.write('<div class="qr-subtitle">'+venue.name+'</div>');
w.document.write('<div><img src="'+dataURL+'" width="300" height="300" alt="QR"/></div>');
w.document.write('<div class="qr-url">'+qrURL+'</div>');
w.document.write('</body></html>');
w.document.close();
setTimeout(()=>w.print(),500);
}catch(err){alert('Errore: '+err.message);if(document.body.contains(div))document.body.removeChild(div);}
};

const deleteUser=async(userId)=>{
if(!confirm('Sei sicuro di voler eliminare questo utente?'))return;
try{
await fetch(`${API_URL}/admin/users/${userId}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}});
loadUsers();
loadStats();
}catch(err){alert('Errore eliminazione');}
};

const exportEmails=()=>{
const link=document.createElement('a');
link.href=`${API_URL}/admin/export-emails`;
link.download='meeq-newsletter.csv';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
};

const printQRCodes=async()=>{
console.log('Inizio generazione QR, tavoli totali:', rooms.length);

const loadingMsg=document.createElement('div');
loadingMsg.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#E91E8C;color:white;padding:20px 40px;border-radius:10px;font-size:18px;font-weight:bold;z-index:9999';
loadingMsg.textContent='Generazione QR 0/'+rooms.length;
document.body.appendChild(loadingMsg);

// üÜï PWA CENTRALE: QR codes puntano alla PWA centrale
// Usa app.meeq.it quando DNS propagato, altrimenti IP VPS
const pwaCentralURL = 'https://app.meeq.it'; // Cambier√† automaticamente quando DNS propagato
// Fallback per test: 'http://128.140.84.82:3002/app.html'
const baseURL = pwaCentralURL;
console.log('üìç URL base QR codes (PWA centrale):', baseURL);
const qrPages=[];

try{
for(let i=0;i<rooms.length;i++){
console.log('Generando QR per:', rooms[i].name);
loadingMsg.textContent='Generazione QR '+(i+1)+'/'+rooms.length;

const room=rooms[i];
// üÜï PWA CENTRALE: URL formato https://app.meeq.it?tavolo=X
const qrURL=baseURL+'?tavolo='+room.id;
const div=document.createElement('div');
div.style.display='none';
document.body.appendChild(div);

await new Promise((resolve)=>{
try{
new QRCode(div,{text:qrURL,width:300,height:300});
setTimeout(()=>{
const canvas=div.querySelector('canvas');
if(canvas){
qrPages.push({name:room.name,dataURL:canvas.toDataURL()});
console.log('QR generato per:', room.name);
}
document.body.removeChild(div);
resolve();
},200);
}catch(err){
console.error('Errore per '+room.name+':', err);
if(document.body.contains(div)){
document.body.removeChild(div);
}
resolve();
}
});
}

console.log('QR generati:', qrPages.length);
document.body.removeChild(loadingMsg);

if(qrPages.length===0){
alert('Errore: nessun QR code generato. Controlla la console.');
return;
}

const printWindow=window.open('','_blank');
printWindow.document.write('<html><head><title>Meeq QR Codes</title>');
printWindow.document.write('<style>body{margin:0;font-family:Arial}@page{size:A4;margin:0}.qr-page{page-break-after:always;padding:60px;text-align:center;height:297mm;display:flex;flex-direction:column;justify-content:center;align-items:center}.qr-title{font-size:48px;font-weight:900;color:#E91E8C;margin-bottom:20px}.qr-subtitle{font-size:24px;color:#666;margin-bottom:40px}.qr-instructions{font-size:18px;color:#333;margin-top:30px}@media print{body{-webkit-print-color-adjust:exact}}</style>');
printWindow.document.write('</head><body>');

qrPages.forEach(page=>{
printWindow.document.write('<div class="qr-page">');
printWindow.document.write('<div class="qr-title">meeq</div>');
printWindow.document.write('<div class="qr-subtitle">'+page.name+'</div>');
printWindow.document.write('<div><img src="'+page.dataURL+'" width="300" height="300"/></div>');
printWindow.document.write('<div class="qr-instructions"><p><strong>Scansiona il QR code</strong></p><p>Connetti. Scopri. Gioca.</p></div>');
printWindow.document.write('</div>');
});

printWindow.document.write('</body></html>');
printWindow.document.close();
setTimeout(()=>printWindow.print(),500);

}catch(err){
console.error('Errore:', err);
if(document.body.contains(loadingMsg)){
document.body.removeChild(loadingMsg);
}
alert('Errore: '+err.message);
}
};

// üî• Auto-refresh ogni 5 secondi per aggiornamenti in tempo reale
useEffect(()=>{
if(screen==='dashboard'&&token){
const interval=setInterval(()=>{
console.log('üîÑ Auto-refresh stats e utenti...');
loadStats();
loadUsers();
},5000); // 5 secondi (ridotto da 30 per aggiornamenti pi√π frequenti)

return()=>clearInterval(interval);
}
},[screen,token]);

if(screen==='login'){
return(
<div className="min-h-screen flex items-center justify-center p-4" style={{background:'linear-gradient(135deg,#1a1625,#0f0b14)'}}>
<div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
<h1 className="text-4xl font-black text-center mb-2" style={{color:'#E91E8C'}}>meeq admin</h1>
<p className="text-gray-600 text-center mb-8 font-semibold">Pannello di controllo</p>
<form onSubmit={handleLogin} className="space-y-4">
<input type="text" placeholder="Username" value={formData.username} onChange={(e)=>setFormData({...formData,username:e.target.value})} className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg" required/>
<input type="password" placeholder="Password" value={formData.password} onChange={(e)=>setFormData({...formData,password:e.target.value})} className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg" required/>
{error&&<div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm font-semibold">{error}</div>}
<button type="submit" disabled={loading} className="w-full text-white font-bold py-3 rounded-lg shadow-lg" style={{backgroundColor:'#E91E8C'}}>{loading?'Accesso...':'Accedi'}</button>
</form>
</div>
</div>
);
}

return(
<div className="min-h-screen p-6" style={{background:'linear-gradient(135deg,#1a1625,#0f0b14)'}}>
<div className="max-w-7xl mx-auto">
<div className="flex justify-between items-center mb-8">
<h1 className="text-4xl font-black text-white">Dashboard Admin</h1>
<button onClick={()=>{setToken(null);setScreen('login');localStorage.removeItem('meeq_admin_token');}} className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg font-semibold">Logout</button>
</div>

<div className="bg-white rounded-xl p-6 shadow-lg mb-8">
<h2 className="text-2xl font-black mb-4" style={{color:'#E91E8C'}}>üè¢ Locali</h2>
{venueForm?(
<div className="border-2 rounded-lg p-4 mb-4" style={{borderColor:'#E91E8C'}}>
<h3 className="font-bold mb-3">{venueForm.id?'Modifica':'Nuovo'} locale</h3>
<div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
<input placeholder="Nome *" value={venueForm.name||''} onChange={e=>setVenueForm({...venueForm,name:e.target.value})} className="px-3 py-2 border rounded"/>
<input placeholder="Slug" value={venueForm.slug||''} onChange={e=>setVenueForm({...venueForm,slug:e.target.value})} className="px-3 py-2 border rounded"/>
<input placeholder="URL Logo" value={venueForm.logo_url||''} onChange={e=>setVenueForm({...venueForm,logo_url:e.target.value})} className="px-3 py-2 border rounded"/>
<input placeholder="URL Men√π" value={venueForm.menu_url||''} onChange={e=>setVenueForm({...venueForm,menu_url:e.target.value})} className="px-3 py-2 border rounded"/>
<input placeholder="Latitudine" value={venueForm.latitude||''} onChange={e=>setVenueForm({...venueForm,latitude:e.target.value})} className="px-3 py-2 border rounded"/>
<input placeholder="Longitudine" value={venueForm.longitude||''} onChange={e=>setVenueForm({...venueForm,longitude:e.target.value})} className="px-3 py-2 border rounded"/>
<input placeholder="Raggio metri" value={venueForm.radius_meters||80} onChange={e=>setVenueForm({...venueForm,radius_meters:e.target.value})} className="px-3 py-2 border rounded"/>
<input placeholder="API Key centrale" value={venueForm.central_api_key||''} onChange={e=>setVenueForm({...venueForm,central_api_key:e.target.value})} className="px-3 py-2 border rounded" type="password"/>
<input placeholder="Username titolare (per upload menu)" value={venueForm.owner_username||''} onChange={e=>setVenueForm({...venueForm,owner_username:e.target.value})} className="px-3 py-2 border rounded"/>
<input placeholder="Password titolare (nuova, solo per modificare)" value={venueForm.owner_password||''} onChange={e=>setVenueForm({...venueForm,owner_password:e.target.value})} className="px-3 py-2 border rounded" type="password"/>
{venueForm.id?<label className="flex items-center gap-2 mt-2"><input type="checkbox" checked={venueForm.active!==0} onChange={e=>setVenueForm({...venueForm,active:e.target.checked?1:0})}/>Attivo</label>:null}
</div>
<div className="flex gap-2 mt-3">
<button onClick={saveVenue} className="px-4 py-2 rounded font-bold text-white" style={{backgroundColor:'#E91E8C'}}>Salva</button>
<button onClick={()=>setVenueForm(null)} className="px-4 py-2 rounded font-bold bg-gray-200">Annulla</button>
</div>
</div>
):null}
{venues.length===0?(
<p className="text-gray-500">Nessun locale. Clicca &quot;Aggiungi locale&quot;.</p>
):(
<div className="overflow-x-auto">
<table className="w-full text-sm">
<thead><tr className="border-b-2" style={{borderColor:'#E91E8C'}}><th className="text-left p-2 font-bold">Nome</th><th className="text-left p-2 font-bold">Slug</th><th className="text-left p-2 font-bold">Coordinate</th><th className="text-left p-2 font-bold">Azioni</th></tr></thead>
<tbody>
{venues.map(v=>(
<tr key={v.id} className="border-b hover:bg-gray-50">
<td className="p-2 font-semibold">{v.active===0?<span className="text-gray-400 line-through">{v.name}</span>:v.name}</td>
<td className="p-2 text-xs">{v.slug||'-'}</td>
<td className="p-2 text-xs">{v.latitude&&v.longitude?`${v.latitude}, ${v.longitude}`:'-'}</td>
<td className="p-2"><div className="flex flex-wrap gap-2">
<a href={`${window.location.origin}/venue/${v.id}`} target="_blank" rel="noopener" className="text-blue-600 hover:underline">Landing</a>
<a href={`${window.location.origin}/app?venue=${v.id}`} target="_blank" rel="noopener" className="text-green-600 hover:underline">App</a>
<button type="button" onClick={()=>printVenueQR(v)} className="text-purple-600 hover:underline font-semibold">Stampa QR</button>
<button type="button" onClick={()=>uploadMenuAdmin(v)} className="text-indigo-600 hover:underline">Carica menu</button>
<a href={`${window.location.origin}/venue/${v.id}/upload`} target="_blank" rel="noopener" className="text-orange-600 hover:underline">Carica menu (titolare)</a>
<button type="button" onClick={()=>setVenueForm({id:v.id,name:v.name,slug:v.slug,logo_url:v.logo_url,menu_url:v.menu_url,latitude:v.latitude,longitude:v.longitude,radius_meters:v.radius_meters,central_api_key:v.central_api_key,active:v.active,owner_username:v.owner_username||''})} className="text-pink-600 hover:underline">Modifica</button>
</div></td>
</tr>
))}
</tbody>
</table>
</div>
)}
<button onClick={()=>setVenueForm({name:'',slug:'',logo_url:'',menu_url:'',latitude:'',longitude:'',radius_meters:80,central_api_key:'',owner_username:'',owner_password:''})} className="mt-3 px-4 py-2 rounded font-bold text-white" style={{backgroundColor:'#E91E8C'}}>+ Aggiungi locale</button>
</div>

<div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
<div className="bg-white rounded-xl p-6 shadow-lg">
<div className="text-3xl font-black mb-2" style={{color:'#E91E8C'}}>{stats.totalUsers||0}</div>
<div className="text-gray-600 font-semibold">Utenti Totali</div>
</div>
<div className="bg-white rounded-xl p-6 shadow-lg">
<div className="text-3xl font-black text-green-600 mb-2">{stats.onlineUsers||0}</div>
<div className="text-gray-600 font-semibold">Online Ora</div>
</div>
<div className="bg-white rounded-xl p-6 shadow-lg">
<div className="text-3xl font-black text-blue-600 mb-2">{stats.totalMessages||0}</div>
<div className="text-gray-600 font-semibold">Messaggi</div>
</div>
<div className="bg-white rounded-xl p-6 shadow-lg">
<div className="text-3xl font-black text-purple-600 mb-2">{stats.newsletterSubscribers||0}</div>
<div className="text-gray-600 font-semibold">Newsletter</div>
</div>
</div>

<div className="bg-white rounded-xl p-6 shadow-lg mb-8">
<h2 className="text-2xl font-black mb-3" style={{color:'#E91E8C'}}>üîÑ Reset Sistema</h2>
<div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4">
<p className="text-red-700 font-semibold mb-2">‚ö†Ô∏è ATTENZIONE: Questa operazione canceller√†:</p>
<ul className="text-red-600 ml-4 mb-2 space-y-1">
<li>‚Ä¢ Tutti i messaggi</li>
<li>‚Ä¢ Tutte le conversazioni</li>
<li>‚Ä¢ Logout di tutti gli utenti</li>
</ul>
<p className="text-green-700 font-semibold">‚úÖ Gli account utenti saranno mantenuti</p>
</div>
<button 
onClick={handleReset}
disabled={resetLoading}
className="w-full md:w-auto text-white font-bold px-6 py-3 rounded-lg shadow-lg hover:opacity-90 transition-opacity disabled:opacity-50"
style={{backgroundColor:'#ff6b6b'}}
>
{resetLoading?'‚è≥ Reset in corso...':'üîÑ Reset Sistema Ora'}
</button>
{resetMessage==='success'&&(
<div className="mt-4 bg-green-50 border-2 border-green-200 text-green-700 px-4 py-3 rounded-lg font-semibold">
‚úÖ Reset completato con successo! Statistiche aggiornate.
</div>
)}
{resetMessage==='error'&&(
<div className="mt-4 bg-red-50 border-2 border-red-200 text-red-700 px-4 py-3 rounded-lg font-semibold">
‚ùå Errore durante il reset. Riprova.
</div>
)}
</div>

<div className="bg-white rounded-xl p-6 shadow-lg mb-8">
<div className="flex justify-between items-center mb-6">
<h2 className="text-2xl font-black" style={{color:'#E91E8C'}}>Tavoli e QR Codes</h2>
<button onClick={printQRCodes} className="flex items-center gap-2 text-white font-bold px-4 py-2 rounded-lg shadow-lg" style={{backgroundColor:'#E91E8C'}}>
<Printer className="w-5 h-5"/>Stampa QR Codes
</button>
</div>
<div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
{rooms.map(room=>(
<div key={room.id} className="border-2 rounded-lg p-3" style={{borderColor:'#E91E8C'}}>
<h3 className="font-bold text-sm mb-1">{room.name}</h3>
<div className="flex items-center gap-1 text-xs">
<Users className="w-3 h-3" style={{color:'#E91E8C'}}/>
<span className="font-semibold">{room.user_count}</span>
</div>
</div>
))}
</div>
</div>

<div className="bg-white rounded-xl p-6 shadow-lg">
<div className="flex justify-between items-center mb-6">
<h2 className="text-2xl font-black" style={{color:'#E91E8C'}}>Utenti ({users.length})</h2>
<button onClick={exportEmails} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded-lg shadow-lg">
<Download className="w-5 h-5"/>Export CSV
</button>
</div>
<div className="overflow-x-auto">
<table className="w-full text-sm">
<thead>
<tr className="border-b-2" style={{borderColor:'#E91E8C'}}>
<th className="text-left p-2 font-bold">Nome</th>
<th className="text-left p-2 font-bold">Email</th>
<th className="text-left p-2 font-bold">Tavolo</th>
<th className="text-left p-2 font-bold">Status</th>
<th className="text-left p-2 font-bold">Newsletter</th>
<th className="text-left p-2 font-bold">Azioni</th>
</tr>
</thead>
<tbody>
{users.map(user=>(
<tr key={user.id} className="border-b hover:bg-gray-50">
<td className="p-2 font-semibold">{user.nome} {user.cognome}</td>
<td className="p-2 text-xs">{user.email}</td>
<td className="p-2">{user.tavolo||'-'}</td>
<td className="p-2">
<span className={`px-2 py-1 rounded text-xs font-bold ${user.logged_in && (user.is_online !== undefined ? user.is_online : true) ?'bg-green-100 text-green-700':'bg-gray-100 text-gray-600'}`}>
{user.logged_in && (user.is_online !== undefined ? user.is_online : true) ?'Online':'Offline'}
</span>
</td>
<td className="p-2">
<span className={`px-2 py-1 rounded text-xs font-bold ${user.newsletter_accepted?'bg-blue-100 text-blue-700':'bg-gray-100 text-gray-600'}`}>
{user.newsletter_accepted?'S√¨':'No'}
</span>
</td>
<td className="p-2">
<button onClick={()=>deleteUser(user.id)} className="text-red-600 hover:text-red-800">
<Trash className="w-4 h-4"/>
</button>
</td>
</tr>
))}
</tbody>
</table>
</div>
</div>
</div>
</div>
);
}

ReactDOM.render(<AdminApp/>,document.getElementById('root'));
</script>
</body>
</html>
